<!DOCTYPE html>
<html>
<head>
    <title>Test Tracking</title>
</head>
<body>
    <h1>Test du Tracking</h1>
    <button onclick="testScan()">Tester un Scan QR</button>
    <button onclick="testDownload()">Tester un T√©l√©chargement</button>
    <button onclick="checkStats()">V√©rifier les Statistiques</button>
    <div id="result"></div>

    <script>
        let documentId = null;

        async function testScan() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = 'Test du scan en cours...';
            
            try {
                // R√©cup√©rer un document
                const docsResponse = await fetch('/api/admin/documents');
                const documents = await docsResponse.json();
                
                if (documents.length === 0) {
                    resultDiv.innerHTML = 'Aucun document trouv√©. Cr√©ez d\'abord un document.';
                    return;
                }
                
                documentId = documents[0].id;
                resultDiv.innerHTML = `Document s√©lectionn√©: ${documents[0].name} (ID: ${documentId})<br><br>`;
                
                // Simuler un scan QR
                const scanResponse = await fetch(`/api/document-stats/${documentId}/scan`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'User-Agent': 'Test-Browser/1.0'
                    }
                });
                
                if (scanResponse.ok) {
                    resultDiv.innerHTML += '‚úÖ Scan QR simul√© avec succ√®s !<br>';
                } else {
                    resultDiv.innerHTML += `‚ùå Erreur scan: ${scanResponse.status}<br>`;
                }
                
            } catch (error) {
                resultDiv.innerHTML = `‚ùå Erreur: ${error.message}`;
            }
        }

        async function testDownload() {
            if (!documentId) {
                document.getElementById('result').innerHTML = 'S√©lectionnez d\'abord un document avec le test de scan.';
                return;
            }
            
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML += 'Test du t√©l√©chargement en cours...<br>';
            
            try {
                // Simuler un t√©l√©chargement
                const downloadResponse = await fetch(`/api/document-stats/${documentId}/download`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'User-Agent': 'Test-Browser/1.0'
                    }
                });
                
                if (downloadResponse.ok) {
                    resultDiv.innerHTML += '‚úÖ T√©l√©chargement simul√© avec succ√®s !<br>';
                } else {
                    resultDiv.innerHTML += `‚ùå Erreur t√©l√©chargement: ${downloadResponse.status}<br>`;
                }
                
            } catch (error) {
                resultDiv.innerHTML += `‚ùå Erreur: ${error.message}<br>`;
            }
        }

        async function checkStats() {
            if (!documentId) {
                document.getElementById('result').innerHTML = 'S√©lectionnez d\'abord un document avec le test de scan.';
                return;
            }
            
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML += 'V√©rification des statistiques...<br>';
            
            try {
                // R√©cup√©rer les statistiques globales
                const globalResponse = await fetch('/api/admin/document-stats-global');
                if (globalResponse.ok) {
                    const globalStats = await globalResponse.json();
                    resultDiv.innerHTML += `<br>üìä Statistiques globales:<br>`;
                    resultDiv.innerHTML += `Scans QR: ${globalStats.totalScans}<br>`;
                    resultDiv.innerHTML += `T√©l√©chargements: ${globalStats.totalDownloads}<br>`;
                    resultDiv.innerHTML += `Cette semaine: ${globalStats.weeklyScans}<br>`;
                    resultDiv.innerHTML += `Documents: ${globalStats.totalDocuments}<br>`;
                } else {
                    resultDiv.innerHTML += '‚ùå Erreur lors de la r√©cup√©ration des statistiques globales<br>';
                }
                
                // R√©cup√©rer les statistiques du document
                const docsResponse = await fetch('/api/admin/documents');
                const documents = await docsResponse.json();
                const document = documents.find(doc => doc.id === documentId);
                
                if (document) {
                    const statsResponse = await fetch(`/api/document-stats/${documentId}?email=${document.ownerEmail}&password=${document.ownerPassword || ''}`);
                    if (statsResponse.ok) {
                        const stats = await statsResponse.json();
                        resultDiv.innerHTML += `<br>üìÑ Statistiques du document:<br>`;
                        resultDiv.innerHTML += `Scans track√©s: ${stats.qrScans?.length || 0}<br>`;
                        resultDiv.innerHTML += `T√©l√©chargements track√©s: ${stats.downloads?.length || 0}<br>`;
                        resultDiv.innerHTML += `Compteur scans: ${stats.qrScanCount || 0}<br>`;
                        resultDiv.innerHTML += `Compteur t√©l√©chargements: ${stats.downloadCount || 0}<br>`;
                    }
                }
                
            } catch (error) {
                resultDiv.innerHTML += `‚ùå Erreur: ${error.message}<br>`;
            }
        }
    </script>
</body>
</html>
